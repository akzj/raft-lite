# RaftKV 功能要点

本文档详细列出 RaftKV 需要实现的所有功能点，用于指导开发和测试。

## 一、核心功能

### 1.1 基本操作

#### PUT 操作
- [ ] **功能**: 写入键值对
- [ ] **流程**: Client → Leader → Raft Log → Commit → Apply → Response
- [ ] **错误处理**: 
  - NotLeader 错误（重定向到 Leader）
  - 超时处理
  - 网络错误重试
- [ ] **验证**: 
  - 写入后立即读取验证
  - 并发写入测试
  - 大值写入测试（>1MB）

#### GET 操作
- [ ] **功能**: 读取键值对
- [ ] **流程**: Client → Leader → ReadIndex → Wait Apply → Read → Response
- [ ] **线性一致性**: 使用 ReadIndex 确保读操作的线性一致性
- [ ] **优化**: LeaderLease 支持（0-RTT 读）
- [ ] **错误处理**:
  - KeyNotFound 错误
  - NotLeader 错误
- [ ] **验证**:
  - 读已提交的写
  - 读未提交的写（应该失败）
  - 并发读写测试

#### DELETE 操作
- [ ] **功能**: 删除键值对
- [ ] **流程**: 同 PUT 操作
- [ ] **行为**: 删除后 GET 返回 KeyNotFound
- [ ] **验证**:
  - 删除后读取验证
  - 删除不存在的键（幂等）

#### SCAN 操作
- [ ] **功能**: 范围扫描（按前缀）
- [ ] **实现**: 遍历状态机中的键值对
- [ ] **参数**: prefix, limit, offset
- [ ] **性能**: 考虑大范围扫描的性能
- [ ] **验证**:
  - 前缀匹配正确性
  - 结果排序
  - 分页功能

### 1.2 状态机实现

#### KVStateMachine
- [ ] **结构**: 内存 HashMap 存储键值对
- [ ] **Apply**: 将 Raft 日志应用到状态机
- [ ] **快照**: 
  - 创建快照（序列化所有键值对）
  - 恢复快照（反序列化并重建状态）
- [ ] **线程安全**: 使用 RwLock 保护并发访问
- [ ] **验证**:
  - 状态机状态一致性
  - 快照创建和恢复

## 二、集群管理

### 2.1 节点启动

#### 单节点启动
- [ ] **功能**: 启动单个节点（用于测试）
- [ ] **配置**: 数据目录、端口、节点 ID
- [ ] **初始化**: 
  - 创建 FileStorage
  - 初始化 RaftState
  - 启动服务器
- [ ] **验证**: 节点启动后可以正常处理请求

#### 多节点集群启动
- [ ] **功能**: 启动多个节点组成集群
- [ ] **配置**: 节点列表、初始配置
- [ ] **发现**: 节点自动发现或配置指定
- [ ] **验证**: 集群形成后选举 Leader

### 2.2 节点加入

#### 动态添加节点
- [ ] **功能**: 运行时添加新节点到集群
- [ ] **流程**: 
  - 新节点启动
  - 通过配置变更添加到集群
  - 同步数据
- [ ] **验证**: 新节点加入后可以参与投票和复制

#### 节点移除
- [ ] **功能**: 运行时移除节点
- [ ] **流程**: 通过配置变更移除节点
- [ ] **验证**: 节点移除后不再参与集群

### 2.3 配置变更

#### 添加节点
- [ ] **功能**: 使用 Joint Consensus 添加节点
- [ ] **验证**: 配置变更期间系统可用

#### 删除节点
- [ ] **功能**: 使用 Joint Consensus 删除节点
- [ ] **验证**: 配置变更期间系统可用

#### 配置查询
- [ ] **功能**: 查询当前集群配置
- [ ] **返回**: 节点列表、角色、状态

## 三、故障处理

### 3.1 Leader 故障

#### Leader 宕机
- [ ] **场景**: Leader 节点突然宕机
- [ ] **预期**: 
  - 其他节点选举新 Leader
  - 客户端自动重定向到新 Leader
  - 数据不丢失
- [ ] **验证**: 
  - 故障转移时间
  - 数据一致性
  - 客户端重试机制

#### Leader 网络分区
- [ ] **场景**: Leader 与多数派隔离
- [ ] **预期**: 
  - 少数派选举新 Leader
  - 原 Leader 降级为 Follower
- [ ] **验证**: 分区恢复后数据一致性

### 3.2 Follower 故障

#### Follower 宕机
- [ ] **场景**: Follower 节点宕机
- [ ] **预期**: 
  - 集群继续运行（多数派正常）
  - 节点恢复后自动同步数据
- [ ] **验证**: 恢复后数据一致性

#### Follower 网络分区
- [ ] **场景**: Follower 与集群隔离
- [ ] **预期**: 
  - 集群继续运行
  - 分区恢复后自动同步
- [ ] **验证**: 同步延迟和数据一致性

### 3.3 数据恢复

#### 节点重启
- [ ] **场景**: 节点重启
- [ ] **流程**: 
  - 从 FileStorage 恢复硬状态
  - 从日志恢复状态机
  - 从快照恢复（如果存在）
- [ ] **验证**: 
  - 恢复后数据完整性
  - 恢复后集群状态正确

#### 快照恢复
- [ ] **场景**: 从快照恢复状态机
- [ ] **验证**: 快照数据完整性

## 四、性能测试

### 4.1 延迟测试

#### 写延迟
- [ ] **指标**: P50, P95, P99, P999
- [ ] **场景**: 
  - 单节点
  - 3 节点集群
  - 5 节点集群
- [ ] **目标**: P99 < 10ms

#### 读延迟
- [ ] **指标**: P50, P95, P99, P999
- [ ] **场景**: 
  - ReadIndex（1-RTT）
  - LeaderLease（0-RTT）
- [ ] **目标**: P99 < 5ms（LeaderLease）

### 4.2 吞吐量测试

#### 写吞吐
- [ ] **指标**: ops/s
- [ ] **场景**: 
  - 单节点
  - 3 节点集群
  - 不同批次大小
- [ ] **目标**: > 10,000 ops/s（单节点）

#### 读吞吐
- [ ] **指标**: ops/s
- [ ] **场景**: 
  - ReadIndex
  - LeaderLease
- [ ] **目标**: > 50,000 ops/s（单节点）

### 4.3 压力测试

#### 并发客户端
- [ ] **场景**: 多个客户端并发操作
- [ ] **指标**: 吞吐量、延迟、错误率
- [ ] **验证**: 系统稳定性

#### 长时间运行
- [ ] **场景**: 长时间持续负载
- [ ] **指标**: 内存泄漏、性能衰减
- [ ] **验证**: 系统稳定性

#### 大值测试
- [ ] **场景**: 写入大值（1MB, 10MB, 100MB）
- [ ] **指标**: 延迟、吞吐量
- [ ] **验证**: 大值处理能力

## 五、一致性验证

### 5.1 线性一致性验证

#### 读写一致性
- [ ] **验证**: 读操作总是看到已提交的写
- [ ] **方法**: 线性一致性检查器（如 Jepsen 风格）

#### 并发操作
- [ ] **验证**: 并发操作的顺序一致性
- [ ] **方法**: 记录操作历史并验证

### 5.2 故障一致性

#### 故障恢复一致性
- [ ] **验证**: 故障恢复后数据一致性
- [ ] **方法**: 对比所有节点的数据

#### 网络分区一致性
- [ ] **验证**: 分区恢复后数据一致性
- [ ] **方法**: 对比分区前后的数据

## 六、监控和指标

### 6.1 Raft 指标

#### 选举指标
- [ ] **指标**: 
  - 选举次数
  - 选举延迟
  - Term 变化

#### 复制指标
- [ ] **指标**: 
  - Commit Index
  - Apply Index
  - 复制延迟
  - 复制吞吐量

### 6.2 存储指标

#### 磁盘使用
- [ ] **指标**: 
  - 日志段数量
  - 磁盘使用量
  - 快照大小

#### 操作指标
- [ ] **指标**: 
  - PUT/GET/DELETE 操作计数
  - 操作延迟分布
  - 错误计数

### 6.3 系统指标

#### 性能指标
- [ ] **指标**: 
  - CPU 使用率
  - 内存使用率
  - 网络 I/O

#### 业务指标
- [ ] **指标**: 
  - 键值对数量
  - 数据大小
  - 操作 QPS

## 七、工具和接口

### 7.1 客户端工具

#### CLI 工具
- [ ] **功能**: 命令行客户端
- [ ] **命令**: 
  - `put <key> <value>`
  - `get <key>`
  - `delete <key>`
  - `scan <prefix>`
  - `status`

#### 压测工具
- [ ] **功能**: 性能压测工具
- [ ] **参数**: 
  - 并发数
  - 操作类型
  - 键值大小
  - 持续时间
- [ ] **输出**: 延迟、吞吐量、错误率

### 7.2 管理接口

#### 集群管理
- [ ] **功能**: 集群管理 API
- [ ] **操作**: 
  - 添加节点
  - 删除节点
  - 查询状态

#### 调试接口
- [ ] **功能**: 调试和诊断
- [ ] **操作**: 
  - 查看 Raft 状态
  - 查看存储状态
  - 触发快照
  - 手动配置变更

## 八、测试场景

### 8.1 功能测试场景

1. **基本操作测试**
   - PUT → GET 验证
   - PUT → DELETE → GET 验证
   - SCAN 功能测试

2. **并发测试**
   - 多客户端并发写入
   - 读写并发
   - 并发删除

3. **边界测试**
   - 空键/值
   - 大键/值
   - 特殊字符

### 8.2 故障测试场景

1. **节点故障**
   - Leader 宕机
   - Follower 宕机
   - 多个节点宕机

2. **网络故障**
   - 网络分区
   - 网络延迟
   - 网络丢包

3. **存储故障**
   - 磁盘满
   - 磁盘损坏
   - 数据损坏

### 8.3 性能测试场景

1. **负载测试**
   - 低负载（100 ops/s）
   - 中负载（1,000 ops/s）
   - 高负载（10,000 ops/s）

2. **扩展性测试**
   - 3 节点集群
   - 5 节点集群
   - 7 节点集群

3. **长时间运行**
   - 24 小时持续运行
   - 内存泄漏检测
   - 性能衰减检测

## 九、实现优先级

### P0 (必须实现)
- ✅ 基本 PUT/GET/DELETE 操作
- ✅ 单节点和多节点集群
- ✅ 故障恢复
- ✅ 基本性能测试

### P1 (重要)
- ✅ SCAN 操作
- ✅ 配置变更
- ✅ 监控指标
- ✅ 压测工具

### P2 (可选)
- ✅ LeaderLease 优化
- ✅ 批量操作
- ✅ 高级监控
- ✅ 性能优化

## 十、验收标准

### 功能验收
- [ ] 所有 P0 功能实现并通过测试
- [ ] 基本操作正确性 100%
- [ ] 故障场景测试通过

### 性能验收
- [ ] 写延迟 P99 < 10ms
- [ ] 读延迟 P99 < 5ms（LeaderLease）
- [ ] 写吞吐 > 10,000 ops/s
- [ ] 读吞吐 > 50,000 ops/s

### 稳定性验收
- [ ] 24 小时持续运行无故障
- [ ] 故障恢复时间 < 5 秒
- [ ] 无内存泄漏
- [ ] 无数据丢失

